

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BBSaveState &mdash; NEURON  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> NEURON
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Building:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cmake_doc/index.html">NEURON CMake Build</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../new_doc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rxd-tutorials/index.html">Python RXD tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doxygen.html">C/C++ API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NEURON</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>BBSaveState</li>
    
    
<li class="wy-breadcrumbs-aside">
    
        <a href="/nrn/new_doc/simctrl/bbsavestate.html" > Switch to HOC</a>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/py_doc/simctrl/bbsavestate.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
</li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p><dl class="docutils"><dt><a href="#BBSaveState" title="Link to this definition">BBSaveState</a></dt><dd><a href="#BBSaveState.ignore" title="Link to this definition">ignore</a> &middot; <a href="#BBSaveState.restore_test" title="Link to this definition">restore_test</a> &middot; <a href="#BBSaveState.save_test" title="Link to this definition">save_test</a> &middot; <a href="#BBSaveState.vector_play_init" title="Link to this definition">vector_play_init</a></dd></dl></p><div class="section" id="bbsavestate">
<span id="id1"></span><h1>BBSaveState<a class="headerlink" href="#bbsavestate" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt id="BBSaveState">
<em class="property">class </em><code class="descname">BBSaveState</code><a class="headerlink" href="#BBSaveState" title="Permalink to this definition">¶</a></dt>
<dd><p>A more flexible, cell centered version of <a class="reference internal" href="savstate.html#SaveState" title="SaveState"><code class="xref py py-class docutils literal notranslate"><span class="pre">SaveState</span></code></a></p>
<p>The goal is to be able to save state to a file and restore state when the
save and restore contexts have different numbers of processors, different
distribution of gids, and different splitting. It needs to work efficiently
in the context of many GByte file sizes and many thousands of processors.</p>
<p>The class was originally developed with the needs of the BlueBrain
neocortical model in mind.</p>
<p>The following code fragment illustrates a basic test. When ‘restore’
is False, the simulation run stops half way and saves the state and then
continues. When ‘restore’ is True, the simulation begins at the previous
save time and continues to tstop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">prun</span><span class="p">(</span><span class="n">tstop</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
   <span class="n">pc</span><span class="o">.</span><span class="n">set_maxstep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
   <span class="n">h</span><span class="o">.</span><span class="n">stdinit</span><span class="p">()</span>
   <span class="n">bbss</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">BBSaveState</span><span class="p">()</span>
   <span class="k">if</span> <span class="n">restore</span><span class="p">:</span>
     <span class="n">bbss</span><span class="o">.</span><span class="n">restore_test</span><span class="p">()</span>
     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after restore t=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">pc</span><span class="o">.</span><span class="n">psolve</span><span class="p">(</span><span class="n">tstop</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">bbss</span><span class="o">.</span><span class="n">save_test</span><span class="p">()</span>
   <span class="n">pc</span><span class="o">.</span><span class="n">psolve</span><span class="p">(</span><span class="n">tstop</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that files are saved in a subdirectory called “out” and restored
from a subdirectory called “in”. An empty “out” folder should be created by
the user prior to calling save_test(). A script filter
(see <a class="reference internal" href="#BBSaveState.save_test" title="BBSaveState.save_test"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BBSaveState.save_test()</span></code></a>) is needed to copy and sometimes
concatenate files from the out to the in subfolders. These files have
an ascii format.</p>
<p>BBSaveState has a c++ API that allows one to replace the file reader and
writer. See nrn/src/nrniv/bbsavestate.cpp for a description of this API.
The undocumented methods, save_test_bin and restore_test_bin demonstrate
the use of this API.</p>
<p>The user can mark a point process IGNORE by calling the method
bbss.ignore(point_process_object)
on all the point processes to be ignored.
The internal list of ignored point processes can be cleared by calling
bbss.ignore()</p>
<p>Because a restore clears the event queue and because one cannot call
finitialize from hoc without vitiating the restore, Vector.play will
not work unless one calls BBSaveState.vector_play_init() after a
restore (similarly frecord() must be called for Vector.record to work.
Note that it is necessary that Vector.play use a tvec argument with
a first element greater than or equal to the restore time.</p>
<p>Some model restrictions:</p>
<ol class="arabic simple">
<li>“Real” cells must have gids.</li>
<li>Artificial cells can have gids. If not they must be directly connected
to just one synapse (e.g. NetStim -&gt; NetCon -&gt; synapse).</li>
<li>There is only one spike output port per cell and that is associated
with a base gid.</li>
<li>NetCon.event in Hoc can be used only with NetCon’s with a None source.</li>
</ol>
<p>To allow extra state, such as Random sequence, to be saved for
POINT_PROCESS or SUFFIX density nmodl mechanisms,
declare  FUNCTION bbsavestate() within the mechanism.
That function is called when the
mechanism instance is saved and restored.
FUNCTION bbsavestate takes two pointers to double arrays
xdir and xval.
The first double array, xdir, has length 1 and xdir[0] is -1.0, 0.0, or 1.0
If xdir[0] == -1.0, then replace the xdir[0] with the proper number of elements
of xval and return 0.0.  If xdir[0] == 0.0, then save double values into
the xval array (which will be sized correctly from a previous call with
xdir[0] == -1.0). If xdir[0] == 1.0, then the saved double values are in
xval and should be restored to their original values.
The number of elements saved/restored has to be apriori known by the instance
since the size of the xval that was saved is not sent to the instance on
restore.</p>
<p>For example</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>   FUNCTION bbsavestate() {
     bbsavestate = 0
   VERBATIM
     double *xdir, *xval, *hoc_pgetarg();
     xdir = hoc_pgetarg(1);
     if (*xdir == -1.) { *xdir = 2; return 0.0; }
     xval = hoc_pgetarg(2);
     if (*xdir == 0.) { xval[0] = 20.; xval[1] = 21.;}
     if (*xdir == 1) { printf(&quot;%d %d\n&quot;, xval[0]==20.0, xval[1] == 21.0); }
   ENDVERBATIM
   }
</pre></div>
</div>
</dd></dl>

<hr class="docutils" />
<dl class="py method">
<dt id="BBSaveState.save_test">
<code class="descclassname">BBSaveState.</code><code class="descname">save_test</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BBSaveState.save_test" title="Permalink to this definition">¶</a></dt>
<dd><dl class="docutils">
<dt>Syntax:</dt><dd><code class="docutils literal notranslate"><span class="pre">.save_test()</span></code></dd>
<dt>Description:</dt><dd>State of the model is saved in files within the subdirectory, <cite>out</cite>.</dd>
<dt>The file <cite>out/tmp</cite> contains the value of t. Other files have the</dt><dd><p>filename format tmp.&lt;gid&gt;.&lt;rank&gt; . Only in the case of multisplit
is it possible to have the same gid in more than one filename. Note
that the out folder needs to be created by the user prior to a call
to save_test().</p>
<p>To prepare for a restore, the tmp.&lt;gid&gt;.&lt;rank&gt; files should be copied
from the <cite>out</cite> subfolder to a subfolder called <cite>in</cite>, with the filename
in/tmp.&lt;gid&gt; . Each file should begin with a first line that specifies
the number of files in the <cite>out</cite> folder that had the same gid.</p>
<p>The following out2in.sh script shows how to do this (not particularly
efficiently).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
rm -f in/*
cat out/tmp &gt; in/tmp
for f in out/tmp.*.* ; do
  echo $f
  i=`echo &quot;$f&quot; | sed &#39;s/.*tmp\.\([0-9]*\)\..*/\1/&#39;`
  echo $i
  if test ! -f in/tmp.$i ; then
    cnt=`ls out/tmp.$i.* | wc -l`
    echo $cnt &gt; in/tmp.$i
    cat out/tmp.$i.* &gt;&gt; in/tmp.$i
  fi
done
</pre></div>
</div>
</dd>
</dl>
</dd></dl>

<hr class="docutils" />
<dl class="py method">
<dt id="BBSaveState.restore_test">
<code class="descclassname">BBSaveState.</code><code class="descname">restore_test</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BBSaveState.restore_test" title="Permalink to this definition">¶</a></dt>
<dd><dl class="docutils">
<dt>Syntax:</dt><dd><code class="docutils literal notranslate"><span class="pre">.restore_test()</span></code></dd>
<dt>Description:</dt><dd>State of the model is restored from files within the
subdirectory, “in”. The file “in/tmp” supplies the value of t.</dd>
<dt>Other files have the filename format tmp.&lt;gid&gt; and are read when</dt><dd>that gid is restored. Note that in a multisplit context, the same
“in/tmp.&lt;gid&gt;” file will be read by multiple ranks, but only the state
assocated with sections that exist on a rank will be restored.</dd>
</dl>
</dd></dl>

<hr class="docutils" />
<dl class="py method">
<dt id="BBSaveState.ignore">
<code class="descclassname">BBSaveState.</code><code class="descname">ignore</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BBSaveState.ignore" title="Permalink to this definition">¶</a></dt>
<dd><dl class="docutils">
<dt>Syntax:</dt><dd><code class="docutils literal notranslate"><span class="pre">.ignore(ppobj)</span></code></dd>
</dl>
<p>Description:</p>
<blockquote>
<div>Point processes can be marked IGNORE
which will skip them on save/restore.
The internal list of these ignored point processes must be the same
on save and restore.</div></blockquote>
</dd></dl>

<hr class="docutils" />
<dl class="py method">
<dt id="BBSaveState.vector_play_init">
<code class="descclassname">BBSaveState.</code><code class="descname">vector_play_init</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BBSaveState.vector_play_init" title="Permalink to this definition">¶</a></dt>
<dd><dl class="docutils">
<dt>Syntax:</dt><dd><code class="docutils literal notranslate"><span class="pre">.vector_play_init()</span></code></dd>
<dt>Description:</dt><dd>Allow <a class="reference internal" href="../programming/math/vector.html#Vector.play" title="Vector.play"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Vector.play()</span></code></a> to work. Call this method after a restore
if there are any Vector.play in the model.</dd>
</dl>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Duke, Yale and the Blue Brain Project

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>